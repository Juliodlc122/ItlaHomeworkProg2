@page "/crear-prenda"
@inject HttpClient Http
@using System.Net.Http.Headers

<h3>Subir Ropa</h3>

<EditForm Model="@modelo" OnValidSubmit="Guardar">
    <label>Nombre:</label>
    <InputText @bind-Value="modelo.Nombre" class="form-control" />

    <label>Precio:</label>
    <InputNumber @bind-Value="modelo.Precio" class="form-control" />

    <label>Foto:</label>
    <InputFile OnChange="SubirFoto" class="form-control" />

    <button type="submit" class="btn btn-primary mt-2">Guardar</button>
</EditForm>

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-info mt-2">@mensaje</div>
}

@code {
    public class RopaDto { public string Nombre { get; set; } = ""; public decimal Precio { get; set; } }

    private RopaDto modelo = new();
    private string mensaje = "";
    private Microsoft.AspNetCore.Components.Forms.IBrowserFile? archivo;

    private void SubirFoto(InputFileChangeEventArgs e) => archivo = e.File;

    private async Task Guardar()
    {
        var content = new MultipartFormDataContent();
        content.Add(new StringContent(modelo.Nombre), "Nombre");
        content.Add(new StringContent(modelo.Precio.ToString()), "Precio");

        if (archivo != null)
        {
            var fileContent = new StreamContent(archivo.OpenReadStream(1024 * 1024 * 5)); 
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(archivo.ContentType);
            content.Add(fileContent, "Imagen", archivo.Name);
        }

        var respuesta = await Http.PostAsync("api/ropa/crear", content);

        if (respuesta.IsSuccessStatusCode) mensaje = "¡Guardado con éxito!";
        else mensaje = "Error al guardar.";
    }
}